@model GoatSilencerArchitecture.Utilities.PaginatedList<GoatSilencerArchitecture.Models.Project>

@section Styles {
    <link rel="stylesheet" href="~/css/Admin/Projects/Shared.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
    <style>
        .sortable-placeholder {
            border: 2px dashed #ccc;
            background-color: #f7f7f7;
            height: 70px;
        }

        .edit-mode-table {
            transform: scale(1.05);
            transform-origin: center;
            transition: transform 0.2s ease;
        }
    </style>
}

@{
    ViewData["Title"] = "Projects";
    var currentSort = ViewData["CurrentSort"] as string;

    string GetSortIndicator(string sortParam)
    {
        if (string.IsNullOrEmpty(currentSort) && sortParam == "UpdatedUtc")
            return " &#9660;"; // Default sort

        if (currentSort == sortParam)
            return " &#9650;"; // Asc

        var descParam = char.ToLower(sortParam[0]) + sortParam.Substring(1) + "_desc";
        if (currentSort == descParam)
            return " &#9660;"; // Desc

        return "";
    }

    string GetSortClass(string sortParam)
    {
        if (string.IsNullOrEmpty(currentSort) && sortParam == "UpdatedUtc")
            return "sort-active";

        var descParam = char.ToLower(sortParam[0]) + sortParam.Substring(1) + "_desc";
        if (currentSort == sortParam || currentSort == descParam)
            return "sort-active";

        return "";
    }
}

<h1>Projects</h1>

<div class="mb-3">
    <button id="edit-mode-btn" class="btn btn-primary">Edit Mode</button>
    <button id="save-changes-btn" class="btn btn-secondary" style="display: none;">Save Changes</button>
    <div id="layout-options" style="display: none; margin-left: 10px;">
        <select id="layout-select" class="form-select">
            <option selected>Select Layout</option>
            <option value="1">Layout 1</option>
            <option value="2">Layout 2</option>
            <option value="3">Layout 3</option>
        </select>
    </div>
</div>

<p>
    <a asp-action="Create" class="btn btn-primary">Create New</a>
</p>

<form asp-action="Index" method="get" id="search-form">
    @Html.AntiForgeryToken()
    <div class="form-actions no-color">
        <p>
            Find by name:
            <input type="text" name="SearchString" value="@ViewData["CurrentFilter"]" id="search-input" />
            <input type="submit" value="Search" class="btn btn-default" /> |
            <a asp-action="Index">Back to Full List</a>
        </p>
    </div>
</form>

<table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>@Html.DisplayNameFor(model => model.FirstOrDefault().Id)</th>
            <th>Main Image</th>
            <th class="@GetSortClass("SortOrder")">
                <a asp-action="Index"
                   asp-route-sortOrder="@(ViewData["SortOrderSortParm"])"
                   asp-route-currentFilter="@(ViewData["CurrentFilter"])"
                   class="sort-link">
                    @Html.DisplayNameFor(model => model.FirstOrDefault().SortOrder)
                    @Html.Raw(GetSortIndicator("SortOrder"))
                </a>
            </th>
            <th>@Html.DisplayNameFor(model => model.FirstOrDefault().Title)</th>
            <th>@Html.DisplayNameFor(model => model.FirstOrDefault().IsPublished)</th>
            <th class="@GetSortClass("CreatedUtc")">
                <a asp-action="Index"
                   asp-route-sortOrder="@(ViewData["CreatedUtcSortParm"])"
                   asp-route-currentFilter="@(ViewData["CurrentFilter"])"
                   class="sort-link">
                    @Html.DisplayNameFor(model => model.FirstOrDefault().CreatedUtc)
                    @Html.Raw(GetSortIndicator("CreatedUtc"))
                </a>
            </th>
            <th class="@GetSortClass("UpdatedUtc")">
                <a asp-action="Index"
                   asp-route-sortOrder="@(ViewData["UpdatedUtcSortParm"])"
                   asp-route-currentFilter="@(ViewData["CurrentFilter"])"
                   class="sort-link">
                    @Html.DisplayNameFor(model => model.FirstOrDefault().UpdatedUtc)
                    @Html.Raw(GetSortIndicator("UpdatedUtc"))
                </a>
            </th>
            <th>@Html.DisplayNameFor(model => model.FirstOrDefault().YearBuilt)</th>
            <th>@Html.DisplayNameFor(model => model.FirstOrDefault().Location)</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="projects-tbody">
        @foreach (var item in Model)
        {
            <tr data-id="@item.Id">
                <td>@Html.DisplayFor(modelItem => item.Id)</td>
                <td>
                    @if (item.MainImage != null && !string.IsNullOrEmpty(item.MainImage.ImageUrl))
                    {
                        <img src="@item.MainImage.ImageUrl" alt="@item.MainImage.AltText"
                             class="thumb-img" style="width:80px; height:60px; object-fit:cover;" />
                    }
                    else
                    {
                        <span class="text-muted">No image</span>
                    }
                </td>
                <td class="sort-order-cell">@Html.DisplayFor(modelItem => item.SortOrder)</td>
                <td>@Html.DisplayFor(modelItem => item.Title)</td>
                <td>
                    <input type="checkbox" class="is-published-checkbox" @(item.IsPublished ? "checked" : "") disabled />
                </td>
                <td>@Html.DisplayFor(modelItem => item.CreatedUtc)</td>
                <td>@Html.DisplayFor(modelItem => item.UpdatedUtc)</td>
                <td>@Html.DisplayFor(modelItem => item.YearBuilt)</td>
                <td>@Html.DisplayFor(modelItem => item.Location)</td>
                <td>
                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary">Edit</a>
                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-outline-info">Details</a>
                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-outline-danger">Delete</a>
                </td>
            </tr>
        }
    </tbody>
</table>

@{
    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
}

<div class="d-flex justify-content-between mt-3">
    <a asp-action="Index"
       asp-route-sortOrder="@(ViewData["CurrentSort"])"
       asp-route-pageNumber="@(Model.PageIndex - 1)"
       asp-route-currentFilter="@(ViewData["CurrentFilter"])"
       class="btn btn-default @prevDisabled">
        Previous
    </a>
    <a asp-action="Index"
       asp-route-sortOrder="@(ViewData["CurrentSort"])"
       asp-route-pageNumber="@(Model.PageIndex + 1)"
       asp-route-currentFilter="@(ViewData["CurrentFilter"])"
       class="btn btn-default @nextDisabled">
        Next
    </a>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>

    <script>
        // --- Search debounce ---
        (function () {
            let timeout = null;
            const searchInput = document.getElementById('search-input');
            const searchForm = document.getElementById('search-form');

            if (searchInput && searchForm) {
                searchInput.addEventListener('input', function () {
                    clearTimeout(timeout);
                    timeout = setTimeout(function () {
                        searchForm.submit();
                    }, 1000);
                });
            }
        })();

        // --- Edit Mode Toggle ---
        $(function () {
            let editMode = false;

            const editModeBtn = $('#edit-mode-btn');
            const saveChangesBtn = $('#save-changes-btn');
            const projectsTbody = $('#projects-tbody');
            const isPublishedCheckboxes = $('.is-published-checkbox');
            const layoutOptions = $('#layout-options');

            function applyEditMode() {
                if (editMode) {
                    // Edit Mode ON
                    editModeBtn
                        .text('Cancel Edit')
                        .removeClass('btn-primary')
                        .addClass('btn-secondary');

                    saveChangesBtn.show();
                    layoutOptions.show();
                    $('table').addClass('edit-mode-table');
                    isPublishedCheckboxes.prop('disabled', false);

                    // Enable sortable rows
                    projectsTbody.sortable({
                        cursor: 'move',
                        placeholder: 'sortable-placeholder',
                        helper: function (e, tr) {
                            const $originals = tr.children();
                            const $helper = tr.clone();
                            $helper.children().each(function (index) {
                                $(this).width($originals.eq(index).width());
                            });
                            return $helper;
                        },
                        update: function () {
                            projectsTbody.find('tr').each(function (index, row) {
                                $(row).find('.sort-order-cell').text(index + 1);
                            });
                        }
                    }).disableSelection();

                } else {
                    // Edit Mode OFF
                    editModeBtn
                        .text('Edit Mode')
                        .removeClass('btn-secondary')
                        .addClass('btn-primary');

                    saveChangesBtn.hide();
                    layoutOptions.hide();
                    $('table').removeClass('edit-mode-table');
                    isPublishedCheckboxes.prop('disabled', true);

                    const hasSortable = projectsTbody.data('ui-sortable') || projectsTbody.data('sortable');
                    if (hasSortable) {
                        projectsTbody.sortable('destroy');
                    }
                }
            }

            editModeBtn.on('click', function () {
                editMode = !editMode;
                applyEditMode();
            });

            saveChangesBtn.on('click', function () {
                const projects = [];
                projectsTbody.find('tr').each(function (index, row) {
                    const id = $(row).data('id');
                    const isPublished = $(row).find('.is-published-checkbox').is(':checked');
                    projects.push({ id: id, isPublished: isPublished, sortOrder: index + 1 });
                });

                const layoutType = $('#layout-select').val();

                const request = {
                    projects: projects,
                    projectsMainPageLayoutType: layoutType
                };

                $.ajax({
                    url: '@Url.Action("UpdateProjects", "Projects")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(request),
                    headers: {
                        RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function () {
                        location.reload();
                    },
                    error: function () {
                        alert('An error occurred while saving the changes.');
                    }
                });
            });

            // Initialize (edit mode OFF)
            applyEditMode();

            // Pre-select layout
            const layoutType = '@ViewData["ProjectsMainPageLayoutType"]';
            if (layoutType) {
                $('#layout-select').val(layoutType);
            }
        });
    </script>
}
